<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Main Bank</title>
  <style>
    :root{
      --bg:#1e1e2f; --panel:#2e2e3e; --muted:#3b3b4f; --text:#fff; --sub:#aabfff;
      --ok:#4CAF50; --bad:#f44336; --ink:#ddd; --line:#444; --chip:#666;
    }
    *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,Arial,sans-serif}
    .page{display:grid;grid-template-columns:260px 1fr;min-height:100vh}
    nav{padding:18px;background:#232336;border-right:1px solid var(--line)}
    nav h1{margin:0 0 12px 0;font-size:18px;color:#eaeaff}
    nav button, nav a{display:block;width:100%;margin:6px 0;padding:12px;border:0;border-radius:8px;background:#444;color:#fff;cursor:pointer;text-align:left}
    nav button:hover,nav a:hover{background:#595959}
    main{padding:22px 26px}
    .grid{display:grid;gap:18px}
    .grid.cols-2{grid-template-columns:1fr 1fr}
    .grid.cols-3{grid-template-columns:1fr 1fr 1fr}
    .card{background:var(--panel);border-radius:14px;padding:18px}
    .card h2{margin:0 0 10px 0;font-size:18px}
    .muted{color:#cfd1ff}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .pill{background:var(--muted);padding:6px 10px;border-radius:999px;font-size:12px}
    .table{width:100%;border-collapse:collapse}
    .table th,.table td{border-bottom:1px solid var(--line);padding:10px;text-align:left}
    .table tfoot td{font-weight:700}
    input[type="text"],input[type="number"],select,textarea{
      background:#444;border:1px solid var(--chip);color:#fff;padding:10px;border-radius:8px;width:100%;
    }
    textarea{min-height:70px;resize:vertical}
    .btn{padding:10px 12px;border:0;border-radius:8px;cursor:pointer; text-decoration: none; display: inline-block;}
    .btn.primary{background:#3e63dd;color:#fff}
    .btn.good{background:var(--ok);color:#fff}
    .btn.bad{background:var(--bad);color:#fff}
    .btn.ghost{background:#444;color:#fff}
    .btn.small{padding: 5px 10px; font-size: 12px;}
    .right{justify-content:flex-end}
    .hint{font-size:12px;opacity:.8}
    .kpi{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:10px}
    .kpi .card{padding:14px}
    .kpi h3{margin:0 0 6px 0;font-size:12px;color:#c9c9ff}
    .kpi .val{font-weight:800;font-size:20px}
    .stack{display:flex;flex-direction:column;gap:10px}
    .sep{height:1px;background:var(--line);margin:12px 0}
    .badge-red{background:#3a2222;color:#ffb3b3; padding: 2px 5px; border-radius: 4px; font-weight: 500;}
    .badge-green{background:#1e3a2f;color:#b9ffd1; padding: 2px 5px; border-radius: 4px; font-weight: 500;}
    .badge-blue{background:#22313d;color:#cfe9ff; padding: 2px 5px; border-radius: 4px; font-weight: 500;}
    .warning{color:#ffd27d;font-size:12px}
    .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}
    
    /* Activity Log Styles */
    .activity-log {
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
        font-size: 12px;
        height: 250px; /* Matched height */
        overflow-y: auto;
    }
    .activity-log-list {
        list-style-type: none;
        padding: 0;
        margin: 0;
    }
    .activity-log-list li {
        padding: 6px;
        border-bottom: 1px solid #3b3b4f;
        color: #ddd;
    }
    .activity-log-list li:last-child {
        border-bottom: none;
    }
    .activity-log-list .log-time {
        color: #999;
        margin-right: 8px;
    }
    .activity-log-list .log-positive { color: #4CAF50; }
    .activity-log-list .log-negative { color: #f44336; }
    
    /* Modal */
    .modal-overlay {
      position: fixed; inset: 0;
      background: rgba(0,0,0,.7);
      display: none; /* Toggled to flex */
      align-items: center; justify-content: center;
      z-index: 1000;
      padding: 1rem;
    }
    .modal {
      background-color: #2e2e3e;
      border-radius: 12px;
      width: min(500px, 92vw);
      padding: 24px; color: #fff;
    }
    .modal-header {
      display: flex; justify-content: space-between; align-items: center;
      margin-bottom: 16px;
    }
    .close-btn { background: none; border: none; color: #fff; font-size: 28px; cursor: pointer; }

  </style>
</head>
<body>
<div class="page">
  <nav>
    <h1>üè¶ Main Bank</h1>
    <a href="DASHBOARD.HTML">‚Üê Back to Dashboard</a>
    <button id="refreshBtn">Refresh data</button>
    <div class="sep"></div>
    <div class="hint">All data auto-saves to localStorage for now and can be swapped to API later.</div>
  </nav>

  <main>
    <!-- NEW: Live Balance Sheet -->
    <section class="card">
        <div class="row" style="justify-content: space-between;">
            <h2>Live Balance Sheet (Today)</h2>
            <button class="btn ghost small" id="exportBalanceSheetBtn">Export CSV</button>
        </div>
        <div class="hint">This is an automated summary of all live funds. "Opening" balances are calculated based on today's activity.</div>
        <div class="sep"></div>
        <div style="overflow-x: auto;">
            <table class="table" id="balanceSheetTable">
                <thead>
                    <tr>
                        <th>Location</th>
                        <th class="mono">Opening House</th>
                        <th class="mono">+ Receipts</th>
                        <th class="mono">- Expenses</th>
                        <th class="mono">+/- Game Rev</th>
                        <th class="mono">= Ending House (Live)</th>
                        <th class="mono">Guest Balance (Live)</th>
                        <th class="mono">= Total Location</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- JS will fill this -->
                </tbody>
                <tfoot>
                    <!-- JS will fill this -->
                </tfoot>
            </table>
        </div>
    </section>

    <!-- MODIFIED: House Balances (now with Add/Deduct) -->
    <section class="grid cols-2" style="margin-top:18px;">
        <div class="card">
            <h2>House Balances by Location</h2>
            <div class="hint">Use buttons to add or deduct funds from the house balance.</div>
            <table class="table" id="houseTable">
              <thead><tr><th>Location</th><th>House Balance</th><th>Actions</th></tr></thead>
              <tbody><!-- rows inserted --></tbody>
              <tfoot><tr><td>Total House</td><td class="mono" id="houseTotal">‚Ç±0.00</td><td></td></tr></tfoot>
            </table>
            <!-- REMOVED: Save House Balances Button -->
        </div>

        <!-- Activity Log Card (Moved) -->
        <div class="card">
            <h2>Recent House Activity</h2>
            <div class="activity-log">
                <ul class="activity-log-list" id="activityLogList">
                    <!-- <li><span class="log-time">[11/11/2025]</span> Game Settle: +1000</li> -->
                </ul>
            </div>
        </div>
    </section>

    <!-- MODIFIED: Inventories (now dynamic) -->
    <section class="grid cols-2" style="margin-top:18px;">
        <div class="card">
            <h2>Inventories</h2>
            <div class="stack">
                <div class="row" style="justify-content: space-between;">
                    <span class="pill">Crypto</span>
                    <div>
                        <button class="btn good small" id="cryptoTransferInBtn">Transfer In</button>
                        <button class="btn bad small" id="cryptoTransferOutBtn">Transfer Out</button>
                    </div>
                </div>
                <div class="grid cols-2">
                    <div>
                    <label>USDT TRC-20</label>
                    <input id="inv-usdt-trc20" type="number" step="0.01" />
                    </div>
                    <div>
                    <label>USDT ERC-20</label>
                    <input id="inv-usdt-erc20" type="number" step="0.01" />
                    </div>
                </div>
                <div class="sep"></div>
                <div class="row"><span class="pill">Forex</span></div>
                <!-- Dynamic Forex List -->
                <div class="stack" id="forexListContainer">
                    <!-- JS will fill this -->
                </div>
                <!-- Add New Forex Form -->
                <div class="row" style="margin-top: 10px;">
                    <input id="newForexCurrency" type="text" placeholder="New currency code (e.g. CNY)" style="flex: 1;"/>
                    <button class="btn primary small" id="addForexBtn">Add</button>
                </div>
                
                <div class="sep"></div>
                <div class="row right">
                    <button class="btn good" id="saveInvBtn">Save Inventories</button>
                </div>
            </div>
        </div>
        
        <!-- NEW: Crypto Transfer Log -->
        <div class="card">
            <h2>Crypto Transfer Log</h2>
            <div class="activity-log">
                <ul class="activity-log-list" id="cryptoLogList">
                    <!-- JS will fill this -->
                </ul>
            </div>
        </div>
    </section>


    <!-- MODIFIED: Monthly Game Performance (Automated) -->
    <section class="card" style="margin-top:18px;">
      <div class="row" style="justify-content: space-between;">
        <h2>Monthly Game Record (Auto-Calculated)</h2>
        <button class="btn ghost small" id="exportMonthlyGameBtn">Export CSV</button>
      </div>
      <div class="hint">This table sums all 'Settled' games from the Game Record, grouped by month.</div>
      <div class="sep"></div>
      <table class="table" id="gameTable">
        <thead><tr>
          <th>Month</th><th class="mono">Buy In</th><th class="mono">Win/Lose</th>
          <th class="mono">Share Amt</th><th class="mono">Rolling</th><th class="mono">Commission</th>
          <th class="mono">Revenue (Net)</th><th></th>
        </tr></thead>
        <tbody>
          <tr><td colspan="8" class="hint">Click 'Recalculate' to load data.</td></tr>
        </tbody>
        <tfoot><tr><td>Totals</td>
          <td class="mono" id="gmTB">‚Ç±0.00</td><td class="mono" id="gmTWL">‚Ç±0.00</td>
          <td class="mono" id="gmTShare">‚Ç±0.00</td><td class="mono" id="gmTR">‚Ç±0.00</td>
          <td class="mono" id="gmTC">‚Ç±0.00</td>
          <td class="mono" id="gmTRevenue">‚Ç±0.00</td><td></td>
        </tr></tfoot>
      </table>
    </section>

    <!-- MODIFIED: Daily Live View (Automated) -->
    <section class="card" style="margin-top:18px;">
      <div class="row" style="justify-content: space-between;">
        <h2>Live Daily Revenue vs Expenses (Auto-Calculated)</h2>
        <button class="btn ghost small" id="exportDailyNetBtn">Export CSV</button>
      </div>
      <div class="hint">This table sums 'Game Revenue (Net)' from settled games and 'Expenses' from the reimbursement page, grouped by day.</div>
      <div class="sep"></div>
      <table class="table" id="dailyTable">
        <thead><tr><th>Date</th><th class="mono">Game Revenue (Net)</th><th class="mono">Expenses</th><th class="mono">Net</th><th></th></tr></thead>
        <tbody>
          <tr><td colspan="5" class="hint">Click 'Recalculate' to load data.</td></tr>
        </tbody>
        <tfoot><tr><td>Totals</td><td class="mono" id="dyTR">‚Ç±0.00</td><td class="mono" id="dyTE">‚Ç±0.00</td><td class="mono" id="dyTN">‚Ç±0.00</td><td></td></tr></tfoot>
      </table>
    </section>
    
    <!-- NEW: Crypto Transfer Modal -->
    <div id="cryptoTransferModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h2 id="cryptoModalTitle" class="text-2xl font-bold">Crypto Transfer</h2>
                <button id="closeCryptoModalBtn" class="close-btn">&times;</button>
            </div>
            <form id="cryptoTransferForm" class="stack">
                <input type="hidden" id="cryptoTransferType" />
                <div>
                    <label>Currency</label>
                    <select id="cryptoModalCurrency" required>
                        <option value="usdt_trc20">USDT TRC-20</option>
                        <option value="usdt_erc20">USDT ERC-20</option>
                    </select>
                </div>
                <div>
                    <label>Amount</label>
                    <input id="cryptoModalAmount" type="number" step="0.01" min="0" required />
                </div>
                <div>
                    <label>Remarks</label>
                    <textarea id="cryptoModalRemarks" placeholder="e.g. From Binance, To player X, etc." required></textarea>
                </div>
                <div class="row right">
                    <button type="submit" class="btn primary">Process Transfer</button>
                </div>
            </form>
        </div>
    </div>

    <div id="toast" style="position:fixed;bottom:20px;right:20px;padding:12px 16px;border-radius:8px;background:#333;opacity:0;transition:.3s">Saved</div>
  </main>
</div>

<script>
/* ------------------------------------------------------------------
   DataBridge ‚Äî wraps localStorage now, can use fetch() later.
-------------------------------------------------------------------*/
const ACCOUNT_STORAGE_KEY = 'account-dashboard:v1'; // your existing key (accounts/locations)
const MAINBANK_KEY = 'mainbank:v1';
const GAME_RECORD_KEY = 'gamerecord:v1'; 

const DataBridge = {
  async loadAccounts() {
    const raw = localStorage.getItem(ACCOUNT_STORAGE_KEY);
    if (!raw) return { accounts: [], locations: [] };
    const s = JSON.parse(raw);
    return {
      accounts: Array.isArray(s.accounts) ? s.accounts : [],
      locations: Array.isArray(s.locations) ? s.locations : []
    };
  },
  async loadMainbank() {
    const raw = localStorage.getItem(MAINBANK_KEY);
    if (!raw) {
      const init = {
        version: 1,
        createdAt: new Date().toISOString(),
        houseBalances: {}, // {loc: number}
        activityLog: [], // For game settlements
        crypto: { usdt_trc20:0, usdt_erc20:0 },
        cryptoLog: [], // NEW: {id, date, type, currency, amount, remarks}
        forex: [ // NEW: Array structure
            { currency: 'JPY', amount: 0 },
            { currency: 'KRW', amount: 0 },
            { currency: 'USD', amount: 0 },
            { currency: 'HKD', amount: 0 }
        ],
        expenseCategories: [
            "Expense Hotel", "Expense Fnb", "Expense Salary", "Expense Car", "Expense General Supplies",
            "Expense Transportation", "Expense Security", "Expense Rent", "Expense Employee Benefit",
            "Expense Consultation", "Subsciption (incl CC Payment)", "BSM Expense", "BGC Expense",
            "WTP Expense", "PIGO Expense", "Revenue Share", "Losing Back", "Lost & Found Return"
        ],
        expenses: [], // {id,date,category,location,amount,remarks}
        otherReceipts: [], 
        markers: [],  // {id,accountNumber,name,amount,status,remarks}
        monthlyGame: [], // {id,month,buyIn,winLose,share,rolling,commission,promoName,ngr}
        daily: [] // {id,date,rev,exp,net,notes}
      };
      localStorage.setItem(MAINBANK_KEY, JSON.stringify(init));
      return init;
    }
    const data = JSON.parse(raw);
    // --- Migrations and field assurances ---
    if (!data.activityLog) data.activityLog = [];
    if (!data.houseBalances) data.houseBalances = {};
    if (!data.otherReceipts) data.otherReceipts = [];
    if (!data.expenses) data.expenses = [];
    if (!data.markers) data.markers = [];
    if (!data.cryptoLog) data.cryptoLog = []; // NEW
    if (!data.crypto) data.crypto = { usdt_trc20:0, usdt_erc20:0 }; // NEW

    // NEW: Migrate Forex from object to array
    if (data.forex && !Array.isArray(data.forex)) {
        data.forex = Object.keys(data.forex).map(key => ({
            currency: key.toUpperCase(),
            amount: data.forex[key] || 0
        }));
    } else if (!data.forex) {
        data.forex = [
            { currency: 'JPY', amount: 0 }, { currency: 'KRW', amount: 0 },
            { currency: 'USD', amount: 0 }, { currency: 'HKD', amount: 0 }
        ];
    }

    // (Expense category migration remains)
    if (data.junketExpenseCategories || data.nonJunketExpenseCategories) {
        data.expenseCategories = [
            "Expense Hotel", "Expense Fnb", "Expense Salary", "Expense Car", "Expense General Supplies",
            "Expense Transportation", "Expense Security", "Expense Rent", "Expense Employee Benefit",
            "Expense Consultation", "Subsciption (incl CC Payment)", "BSM Expense", "BGC Expense",
            "WTP Expense", "PIGO Expense", "Revenue Share", "Losing Back", "Lost & Found Return"
        ];
        if (data.expenses && data.expenses.length > 0 && data.expenses[0].kind) {
            data.expenses.forEach(e => { delete e.kind; });
        }
        delete data.junketExpenseCategories;
        delete data.nonJunketExpenseCategories;
    }
    if (!data.expenseCategories) {
         data.expenseCategories = ["General"];
    }
    return data;
  },
  async loadGameRecords() {
    const raw = localStorage.getItem(GAME_RECORD_KEY);
    if (!raw) return [];
    try {
        return JSON.parse(raw);
    } catch (e) {
        console.error("Failed to parse game records", e);
        return [];
    }
  },
  async saveMainbank(state) {
    localStorage.setItem(MAINBANK_KEY, JSON.stringify(state));
    return true;
  }
};

// utils
const fmtPHP = (n)=> new Intl.NumberFormat('en-US',{style:'currency',currency:'PHP',minimumFractionDigits:2}).format(+n||0);
const uid = ()=> Math.random().toString(36).slice(2,9);
const toast=(m='Saved')=>{
  const t=document.getElementById('toast'); t.textContent=m; t.style.opacity=1;
  setTimeout(()=>t.style.opacity=0,1200);
};
const isToday = (dateString) => {
    if (!dateString) return false;
    const today = new Date();
    const date = new Date(dateString); 
    return date.getUTCFullYear() === today.getUTCFullYear() &&
           date.getUTCMonth() === today.getUTCMonth() &&
           date.getUTCDate() === today.getUTCDate();
};
// NEW: CSV Export Helper
function exportToCSV(filename, rows) {
    let csvContent = "data:text/csv;charset=utf-8,";
    rows.forEach(rowArray => {
        let row = rowArray.map(cell => {
            let str = String(cell).replace(/"/g, '""');
            if (str.includes(',')) str = `"${str}"`;
            return str;
        }).join(",");
        csvContent += row + "\r\n";
    });

    const encodedUri = encodeURI(csvContent);
    const link = document.createElement("a");
    link.setAttribute("href", encodedUri);
    link.setAttribute("download", filename);
    document.body.appendChild(link); 
    link.click();
    document.body.removeChild(link);
    toast('Exported to CSV');
}


// state
let MB = null;        
let ACC = {accounts:[], locations:[]};
let GAMES = []; 

// DOM refs
const activityLogList = document.getElementById('activityLogList'); 
const houseTBody = document.querySelector('#houseTable tbody');
const houseTotal = document.getElementById('houseTotal');

// --- Inventory Refs ---
const invTrc = document.getElementById('inv-usdt-trc20');
const invErc = document.getElementById('inv-usdt-erc20');
const forexListContainer = document.getElementById('forexListContainer');
const newForexCurrency = document.getElementById('newForexCurrency');
const addForexBtn = document.getElementById('addForexBtn');
const saveInvBtn = document.getElementById('saveInvBtn');

// --- Crypto Modal Refs ---
const cryptoTransferModal = document.getElementById('cryptoTransferModal');
const cryptoModalTitle = document.getElementById('cryptoModalTitle');
const cryptoTransferForm = document.getElementById('cryptoTransferForm');
const cryptoTransferType = document.getElementById('cryptoTransferType');
const cryptoModalCurrency = document.getElementById('cryptoModalCurrency');
const cryptoModalAmount = document.getElementById('cryptoModalAmount');
const cryptoModalRemarks = document.getElementById('cryptoModalRemarks');
const cryptoLogList = document.getElementById('cryptoLogList');


// refresh
document.getElementById('refreshBtn').addEventListener('click', async ()=>{ await boot(); toast('Refreshed'); });

/* -------------------- Rendering -------------------- */

// NEW: Render Balance Sheet
function renderBalanceSheet() {
    const tableBody = document.querySelector('#balanceSheetTable tbody');
    const tableFoot = document.querySelector('#balanceSheetTable tfoot');
    tableBody.innerHTML = '';
    tableFoot.innerHTML = '';

    const today = new Date().toISOString().slice(0, 10);
    
    // 1. Calculate Guest Balances per location
    const guestTotals = {};
    ACC.locations.forEach(loc => guestTotals[loc] = 0);
    ACC.accounts.forEach(a => {
        if (!a.balances) a.balances = {};
        ACC.locations.forEach(loc => guestTotals[loc] += (a.balances?.[loc]||0));
    });

    // 2. Calculate Today's activity per location
    const todayReceipts = {};
    const todayExpenses = {};
    const todayGameRevenue = {};
    ACC.locations.forEach(loc => {
        todayReceipts[loc] = 0;
        todayExpenses[loc] = 0;
        todayGameRevenue[loc] = 0;
    });

    MB.otherReceipts.forEach(r => {
        if (isToday(r.date)) {
            todayReceipts[r.location] = (todayReceipts[r.location] || 0) + (r.amount || 0);
        }
    });
    MB.expenses.forEach(e => {
        if (isToday(e.date)) {
            todayExpenses[e.location] = (todayExpenses[e.location] || 0) + (e.amount || 0);
        }
    });
    GAMES.forEach(g => {
        if (g.status === 'settled' && isToday(g.date)) { 
            todayGameRevenue[g.location] = (todayGameRevenue[g.location] || 0) + (g.revenue || 0);
        }
    });
    
    // 3. Render Table Rows
    let totOpening = 0, totReceipts = 0, totExpenses = 0, totGameRev = 0, totEnding = 0, totGuest = 0, totTotal = 0;

    ACC.locations.forEach(loc => {
        const endingHouse = MB.houseBalances[loc] || 0;
        const receipts = todayReceipts[loc];
        const expenses = todayExpenses[loc];
        const gameRev = todayGameRevenue[loc];
        
        const openingHouse = endingHouse - receipts + expenses - gameRev;
        const guestBalance = guestTotals[loc];
        const totalLocation = endingHouse + guestBalance;

        totOpening += openingHouse;
        totReceipts += receipts;
        totExpenses += expenses;
        totGameRev += gameRev;
        totEnding += endingHouse;
        totGuest += guestBalance;
        totTotal += totalLocation;

        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${cap(loc)}</td>
            <td class="mono">${fmtPHP(openingHouse)}</td>
            <td class="mono ${receipts > 0 ? 'badge-green' : ''}">${fmtPHP(receipts)}</td>
            <td class="mono ${expenses > 0 ? 'badge-red' : ''}">${fmtPHP(expenses)}</td>
            <td class="mono ${gameRev > 0 ? 'badge-green' : (gameRev < 0 ? 'badge-red' : '')}">${fmtPHP(gameRev)}</td>
            <td class="mono">${fmtPHP(endingHouse)}</td>
            <td class="mono">${fmtPHP(guestBalance)}</td>
            <td class="mono">${fmtPHP(totalLocation)}</td>
        `;
        tableBody.appendChild(tr);
    });

    // 4. Render Footer
    const tfoot = document.createElement('tr');
    tfoot.innerHTML = `
        <td><strong>Totals</strong></td>
        <td class="mono"><strong>${fmtPHP(totOpening)}</strong></td>
        <td class="mono"><strong>${fmtPHP(totReceipts)}</strong></td>
        <td class="mono"><strong>${fmtPHP(totExpenses)}</strong></td>
        <td class="mono"><strong>${fmtPHP(totGameRev)}</strong></td>
        <td class="mono"><strong>${fmtPHP(totEnding)}</strong></td>
        <td class="mono"><strong>${fmtPHP(totGuest)}</strong></td>
        <td class="mono"><strong>${fmtPHP(totTotal)}</strong></td>
    `;
    tableFoot.appendChild(tfoot);
}


function renderActivityLog() {
    activityLogList.innerHTML = '';
    if (!MB.activityLog || MB.activityLog.length === 0) {
        activityLogList.innerHTML = '<li>No house activity recorded.</li>';
        return;
    }
    
    MB.activityLog.slice(0, 50).forEach(log => {
        const li = document.createElement('li');
        const timeMatch = log.match(/^\[(.*?)\]\s/);
        let time = '';
        let msg = log;
        
        if (timeMatch) {
            time = timeMatch[1];
            msg = log.replace(timeMatch[0], ''); 
        }
        
        let netClass = '';
        if (msg.includes('Net +') || log.includes('Expense VOID: +') || log.includes('Other Receipt: +') || msg.includes('Crypto IN')) { 
            netClass = 'log-positive';
        } else if (msg.includes('Net -') || log.includes('Expense: -') || log.includes('Receipt VOID: -') || msg.includes('Crypto OUT')) { 
            netClass = 'log-negative';
        }
        
        li.innerHTML = `<span class="log-time">[${time}]</span> <span class="${netClass}">${msg}</span>`;
        activityLogList.appendChild(li);
    });
}

function renderHouseInputs(){
  houseTBody.innerHTML='';
  let t=0;
  ACC.locations.forEach(loc=>{
    const v = +MB.houseBalances[loc]||0;
    const tr=document.createElement('tr');
    tr.innerHTML = `<td>${cap(loc)}</td>
      <td class="mono">${fmtPHP(v)}</td>
      <td>
        <a href="otherreceipt.html" class="btn good small">Add</a>
        <a href="reimbursement.html" class="btn bad small">Deduct</a>
      </td>`;
    houseTBody.appendChild(tr); t+=v;
  });
  houseTotal.textContent = fmtPHP(t);
}

// --- NEW: Render Inventories (Crypto + Forex) ---
function renderInventories() {
    // 1. Render Crypto
    invTrc.value = MB.crypto.usdt_trc20||0;
    invErc.value = MB.crypto.usdt_erc20||0;

    // 2. Render Forex
    forexListContainer.innerHTML = '';
    MB.forex.forEach(item => {
        const div = document.createElement('div');
        div.className = 'row';
        div.innerHTML = `
            <label style="width: 80px;">${item.currency.toUpperCase()}</label>
            <input type="number" step="0.01" value="${item.amount || 0}" data-forex-currency="${item.currency}" style="flex: 1;"/>
            <button class="btn bad small" onclick="handleDeleteForex('${item.currency}')" style="flex-shrink: 0;">Delete</button>
        `;
        forexListContainer.appendChild(div);
    });
}

// --- NEW: Render Crypto Log ---
function renderCryptoLog() {
    cryptoLogList.innerHTML = '';
    if (!MB.cryptoLog || MB.cryptoLog.length === 0) {
        cryptoLogList.innerHTML = '<li>No crypto transfers logged.</li>';
        return;
    }
    
    // Show newest first
    [...MB.cryptoLog].reverse().slice(0, 50).forEach(log => {
        const li = document.createElement('li');
        const ts = new Date(log.date).toLocaleString();
        const typeClass = log.type === 'in' ? 'log-positive' : 'log-negative';
        const typeLabel = log.type === 'in' ? 'IN' : 'OUT';
        
        li.innerHTML = `
            <span class="log-time">[${ts}]</span>
            <span class="${typeClass}" style="font-weight: bold;">${typeLabel} ${log.amount} ${log.currency.toUpperCase()}</span>
            <br>
            <span style="padding-left: 10px; color: #ccc;">${log.remarks}</span>
        `;
        cryptoLogList.appendChild(li);
    });
}


// --- Automated Report Functions ---

function autoRenderMonthlyGame(forExport = false) {
    const gameTBody = document.querySelector('#gameTable tbody');
    const gmTB=document.getElementById('gmTB'), gmTWL=document.getElementById('gmTWL'), gmTShare=document.getElementById('gmTShare'),
          gmTR=document.getElementById('gmTR'), gmTC=document.getElementById('gmTC'), gmTRevenue=document.getElementById('gmTRevenue');
    
    if (!forExport) gameTBody.innerHTML = '';
    let tb=0, twl=0, ts=0, tr=0, tc=0, tRev=0;

    const settledGames = GAMES.filter(g => g.status === 'settled');
    const months = {}; 

    settledGames.forEach(game => {
        const month = game.date.slice(0, 7); 
        if (!months[month]) {
            months[month] = { buyIn: 0, winLose: 0, shareAmount: 0, rolling: 0, commission: 0, revenue: 0 };
        }
        
        const gameWinLose = (game.winLose || 0);
        const gameComm = (game.commissionAmount || 0);
        const gameRolling = (game.rolling || 0);
        const gameGrossShare = (game.shareAmount || 0);
        const gameNetRevenue = (game.revenue || 0);

        months[month].buyIn += (game.capital || 0);
        months[month].winLose += gameWinLose;
        months[month].shareAmount += gameGrossShare; 
        months[month].rolling += gameRolling;
        months[month].commission += gameComm;
        months[month].revenue += gameNetRevenue; 
    });

    const sortedMonths = Object.keys(months).sort().reverse();

    if (sortedMonths.length === 0) {
        if (!forExport) gameTBody.innerHTML = `<tr><td colspan="8" class="hint">No settled games found.</td></tr>`;
    }

    // For CSV Export
    if (forExport) {
        const rows = [
            ["Month", "Buy In", "Win/Lose", "Share Amt", "Rolling", "Commission", "Revenue (Net)"]
        ];
        sortedMonths.forEach(monthKey => {
            const data = months[monthKey];
            rows.push([monthKey, data.buyIn, data.winLose, data.shareAmount, data.rolling, data.commission, data.revenue]);
        });
        rows.push(["Totals", tb, twl, ts, tr, tc, tRev]);
        return rows;
    }

    // For HTML Render
    sortedMonths.forEach(monthKey => {
        const data = months[monthKey];
        tb+=data.buyIn; twl+=data.winLose; ts+=data.shareAmount; tr+=data.rolling; tc+=data.commission; tRev+=data.revenue;
        
        const trEl = document.createElement('tr');
        trEl.innerHTML = `<td>${monthKey}</td>
          <td class="mono">${fmtPHP(data.buyIn)}</td>
          <td class="mono ${data.winLose > 0 ? 'badge-green' : 'badge-red'}">${fmtPHP(data.winLose)}</td>
          <td class="mono ${data.shareAmount > 0 ? 'badge-green' : 'badge-red'}">${fmtPHP(data.shareAmount)}</td>
          <td class="mono">${fmtPHP(data.rolling)}</td>
          <td class="mono">${fmtPHP(data.commission)}</td>
          <td class="mono ${data.revenue > 0 ? 'badge-green' : 'badge-red'}">${fmtPHP(data.revenue)}</td>
          <td></td>`;
        gameTBody.appendChild(trEl);
    });

    gmTB.textContent=fmtPHP(tb); gmTWL.textContent=fmtPHP(twl); gmTShare.textContent=fmtPHP(ts);
    gmTR.textContent=fmtPHP(tr); gmTC.textContent=fmtPHP(tc); gmTRevenue.textContent=fmtPHP(tRev);
    if (!forExport) toast('Monthly game data recalculated');
}

function autoRenderDailyNet(forExport = false) {
    const dailyTBody = document.querySelector('#dailyTable tbody');
    const dyTR=document.getElementById('dyTR'), dyTE=document.getElementById('dyTE'), dyTN=document.getElementById('dyTN');

    if (!forExport) dailyTBody.innerHTML = '';
    let tr=0, te=0, tn=0;

    const days = {}; 

    // 1. Aggregate revenue from settled games
    const settledGames = GAMES.filter(g => g.status === 'settled');
    settledGames.forEach(game => {
        const date = game.date; 
        if (!days[date]) days[date] = { rev: 0, exp: 0 };
        days[date].rev += (game.revenue || 0);
    });

    // 2. Aggregate expenses
    MB.expenses.forEach(expense => {
        const date = expense.date;
        if (!days[date]) days[date] = { rev: 0, exp: 0 };
        days[date].exp += (expense.amount || 0);
    });

    const sortedDays = Object.keys(days).sort().reverse();

    if (sortedDays.length === 0) {
        if (!forExport) dailyTBody.innerHTML = `<tr><td colspan="5" class="hint">No daily data found.</td></tr>`;
    }

    // For CSV Export
    if (forExport) {
        const rows = [
            ["Date", "Game Revenue (Net)", "Expenses", "Net"]
        ];
        sortedDays.forEach(dateKey => {
            const data = days[dateKey];
            const net = data.rev - data.exp;
            rows.push([dateKey, data.rev, data.exp, net]);
        });
        rows.push(["Totals", tr, te, tn]);
        return rows;
    }

    // For HTML Render
    sortedDays.forEach(dateKey => {
        const data = days[dateKey];
        const net = data.rev - data.exp;
        
        tr+=data.rev; te+=data.exp; tn+=net;

        const trEl = document.createElement('tr');
        trEl.innerHTML = `<td>${dateKey}</td>
          <td class="mono ${data.rev > 0 ? 'badge-green' : (data.rev < 0 ? 'badge-red' : '')}">${fmtPHP(data.rev)}</td>
          <td class="mono ${data.exp > 0 ? 'badge-red' : ''}">${fmtPHP(data.exp)}</td>
          <td class="mono ${net > 0 ? 'badge-green' : (net < 0 ? 'badge-red' : '')}">${fmtPHP(net)}</td>
          <td></td>`;
        dailyTBody.appendChild(trEl);
    });

    dyTR.textContent=fmtPHP(tr); dyTE.textContent=fmtPHP(te); dyTN.textContent=fmtPHP(tn);
    if (!forExport) toast('Daily revenue data recalculated');
}


// --- NEW: Inventory Handlers ---
function handleSaveInventories() {
    // 1. Save Crypto
    MB.crypto.usdt_trc20 = +invTrc.value||0;
    MB.crypto.usdt_erc20 = +invErc.value||0;

    // 2. Save Forex
    const newForex = [];
    const inputs = document.querySelectorAll('[data-forex-currency]');
    inputs.forEach(input => {
        const currency = input.dataset.forexCurrency;
        const amount = +input.value || 0;
        newForex.push({ currency, amount });
    });
    MB.forex = newForex;

    DataBridge.saveMainbank(MB);
    toast('Inventories saved');
}

function handleAddForex() {
    const currency = newForexCurrency.value.trim().toUpperCase();
    if (!currency) {
        toast('Currency code cannot be empty', 'bad');
        return;
    }
    if (MB.forex.find(item => item.currency === currency)) {
        toast('Currency already exists', 'bad');
        return;
    }
    MB.forex.push({ currency, amount: 0 });
    DataBridge.saveMainbank(MB);
    renderInventories();
    newForexCurrency.value = '';
}

function handleDeleteForex(currency) {
    if (!confirm(`Are you sure you want to delete ${currency}?`)) return;
    MB.forex = MB.forex.filter(item => item.currency !== currency);
    DataBridge.saveMainbank(MB);
    renderInventories();
    toast(`${currency} deleted`);
}

// --- NEW: Crypto Modal Handlers ---
function openCryptoTransferModal(type) {
    cryptoTransferForm.reset();
    cryptoTransferType.value = type;
    if (type === 'in') {
        cryptoModalTitle.textContent = 'Crypto Transfer In';
    } else {
        cryptoModalTitle.textContent = 'Crypto Transfer Out';
    }
    cryptoTransferModal.style.display = 'flex';
}

function closeCryptoTransferModal() {
    cryptoTransferModal.style.display = 'none';
}

function handleCryptoTransfer(e) {
    e.preventDefault();
    const type = cryptoTransferType.value; // 'in' or 'out'
    const currency = cryptoModalCurrency.value; // 'usdt_trc20' or 'usdt_erc20'
    const amount = +cryptoModalAmount.value;
    const remarks = cryptoModalRemarks.value.trim();

    if (amount <= 0) {
        toast('Amount must be positive', 'bad');
        return;
    }
    if (!remarks) {
        toast('Remarks are required', 'bad');
        return;
    }

    const logEntry = {
        id: uid(),
        date: new Date().toISOString(),
        type,
        currency,
        amount,
        remarks
    };

    // Update inventory
    if (type === 'in') {
        MB.crypto[currency] = (MB.crypto[currency] || 0) + amount;
    } else {
        MB.crypto[currency] = (MB.crypto[currency] || 0) - amount;
    }
    
    // Add to crypto log
    MB.cryptoLog.push(logEntry);

    // Add to main house activity log
    const ts = new Date().toLocaleString();
    const logMsg = `[${ts}] Crypto ${type === 'in' ? 'IN' : 'OUT'}: ${amount} ${currency.toUpperCase()} (${remarks})`;
    MB.activityLog.unshift(logMsg);
    
    DataBridge.saveMainbank(MB);
    toast('Crypto transfer logged');
    
    closeCryptoTransferModal();
    renderInventories();
    renderCryptoLog();
    renderActivityLog();
}

// --- NEW: Export Button Handlers ---
function exportBalanceSheet() {
    const table = document.getElementById('balanceSheetTable');
    const rows = [];
    table.querySelectorAll('tr').forEach(tr => {
        const row = [];
        tr.querySelectorAll('th, td').forEach(cell => {
            // Use textContent to avoid HTML, strip "‚Ç±" and commas for clean numbers
            let text = cell.textContent.replace(/‚Ç±/g, '').replace(/,/g, '');
            row.push(text);
        });
        rows.push(row);
    });
    exportToCSV('mainbank_balance_sheet.csv', rows);
}

function exportMonthlyGame() {
    const rows = autoRenderMonthlyGame(true); // Get data rows
    exportToCSV('mainbank_monthly_game_report.csv', rows);
}

function exportDailyNet() {
    const rows = autoRenderDailyNet(true); // Get data rows
    exportToCSV('mainbank_daily_net_report.csv', rows);
}


// helpers
function cap(s){ return (s||'').charAt(0).toUpperCase()+ (s||'').slice(1); }
function mergeUnique(a,b,key){ const seen=new Set(a.map(x=>key(x))); b.forEach(x=>{const k=key(x);if(!seen.has(k)){a.push(x);seen.add(k);}}); return a; }

/* -------------------- Boot -------------------- */
async function boot(){
  ACC = await DataBridge.loadAccounts(); 
  MB = await DataBridge.loadMainbank();
  GAMES = await DataBridge.loadGameRecords(); 
  
  // render location-dependent UIs
  renderBalanceSheet(); 
  renderActivityLog(); 
  renderHouseInputs(); 
  renderInventories(); // NEW
  renderCryptoLog(); // NEW
  
  // Call auto-renderers
  autoRenderMonthlyGame();
  autoRenderDailyNet();
  
  // Bind recalculate buttons
  document.getElementById('recalcMonthlyBtn').addEventListener('click', () => autoRenderMonthlyGame(false));
  document.getElementById('recalcDailyBtn').addEventListener('click', () => autoRenderDailyNet(false));

  // Bind inventory buttons
  saveInvBtn.addEventListener('click', handleSaveInventories);
  addForexBtn.addEventListener('click', handleAddForex);
  
  // Bind crypto modal buttons
  document.getElementById('cryptoTransferInBtn').addEventListener('click', () => openCryptoTransferModal('in'));
  document.getElementById('cryptoTransferOutBtn').addEventListener('click', () => openCryptoTransferModal('out'));
  document.getElementById('closeCryptoModalBtn').addEventListener('click', closeCryptoTransferModal);
  cryptoTransferForm.addEventListener('submit', handleCryptoTransfer);
  
  // Bind export buttons
  document.getElementById('exportBalanceSheetBtn').addEventListener('click', exportBalanceSheet);
  document.getElementById('exportMonthlyGameBtn').addEventListener('click', exportMonthlyGame);
  document.getElementById('exportDailyNetBtn').addEventListener('click', exportDailyNet);
}

// Add storage listener for real-time updates
window.addEventListener('storage', (e) => {
    if (e.key === MAINBANK_KEY || e.key === ACCOUNT_STORAGE_KEY || e.key === GAME_RECORD_KEY) {
        boot();
    }
});

boot();
</script>
</body>
</html>