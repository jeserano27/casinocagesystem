<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Transaction History</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #1e1e2f; color: white; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-thumb { background: #555; border-radius: 10px; }
        ::-webkit-scrollbar-track { background: #333; }
        
        .table-fixed { table-layout: fixed; width: 100%; }
        .table-fixed th, .table-fixed td {
            padding: 12px 8px;
            font-size: 0.8rem;
            text-align: left;
            word-wrap: break-word;
        }
        .table-fixed th { 
            background-color: #3b3b4f; 
            font-weight: 600;
        }
        .table-fixed td { 
            border-bottom: 1px solid #3b3b4f; 
        }
        .table-fixed tbody tr:nth-child(even) { background-color: #2e2e3e; }
        .table-fixed tbody tr:nth-child(odd) { background-color: #2a2a3a; }
        
        .status-badge { padding: 4px 8px; border-radius: 999px; font-weight: 600; font-size: 0.7rem; line-height: 1; }
        .status-completed { background-color: #2a8a4a; color: #fff; }
        .status-voided { background-color: #a83232; color: #fff; }

        .text-positive { color: #4CAF50; }
        .text-negative { color: #f44336; }

        /* Controls Bar */
        .controls-bar {
            background-color: #2e2e3e;
            padding: 16px;
            border-radius: 12px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 16px;
        }

        /* Notification */
        #notification {
            position: fixed; bottom: 20px; right: 20px; padding: 12px 20px; border-radius: 8px;
            color: white; font-size: 16px; z-index: 1000; transition: all 0.3s ease;
            opacity: 0; transform: translateY(20px);
        }
        #notification.show { opacity: 1; transform: translateY(0); }
        #notification.success { background-color: #4CAF50; }
        #notification.error { background-color: #f44336; }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-7xl mx-auto">
        <!-- Header -->
        <div class="flex justify-between items-center mb-6">
            <h1 class="text-3xl font-bold">Transaction History</h1>
            <button onclick="history.back()" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg">
                &larr; Back
            </button>
        </div>

        <!-- Controls Bar -->
        <div class="controls-bar">
            <!-- Left Side Controls -->
            <div class="flex flex-wrap items-center gap-4">
                <div class="flex items-center gap-2">
                    <label for="filter-account-no" class="text-sm text-gray-200">Account No:</label>
                    <input type="text" id="filter-account-no" placeholder="Enter Account No..." class="bg-gray-700 text-white p-2 rounded-md border border-gray-600 text-sm">
                </div>
                <div class="flex items-center gap-2">
                    <label for="filter-type" class="text-sm text-gray-200">Type:</label>
                    <select id="filter-type" class="bg-gray-700 text-white text-sm rounded-md p-2 border border-gray-600">
                        <option value="all">All Types</option>
                        <option value="Deposit">Deposit</option>
                        <option value="Withdrawal">Withdrawal</option>
                        <option value="Game Buy-in">Game Buy-in</option>
                        <option value="Game Settle">Game Settle</option>
                        <option value="Game R/C">Game R/C</option>
                        <option value="Game Void">Game Void</option>
                        <option value="Void">Void</option>
                    </select>
                </div>
                <div class="flex items-center gap-2">
                    <label for="filter-date-start" class="text-sm text-gray-200">From:</label>
                    <input type="date" id="filter-date-start" class="bg-gray-700 text-white p-2 rounded-md border border-gray-600 text-sm">
                </div>
                <div class="flex items-center gap-2">
                    <label for="filter-date-end" class="text-sm text-gray-200">To:</label>
                    <input type="date" id="filter-date-end" class="bg-gray-700 text-white p-2 rounded-md border border-gray-600 text-sm">
                </div>
                <button id="filter-apply-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-3 rounded-md text-sm">Apply Filters</button>
                <button id="filter-clear-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-medium py-2 px-3 rounded-md text-sm">Clear All</button>
            </div>

            <!-- Right Side Controls -->
            <button id="export-csv-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg">
                Export Visible Data (CSV)
            </button>
        </div>

        <!-- Transaction Table Wrapper -->
        <div class="bg-gray-800 rounded-lg shadow-lg overflow-hidden">
            <div class="overflow-x-auto">
                <table class="table-fixed w-full min-w-[1000px] text-left">
                    <thead>
                        <tr>
                            <th class="w-[12%]">Date & Time</th>
                            <th class="w-[10%]">Account No</th>
                            <th class="w-[12%]">Type</th>
                            <th class="w-[10%]">Amount</th>
                            <th class="w-[10%]">Location</th>
                            <th class="w-[10%]">Status</th>
                            <th class="w-[26%]">Remarks</th>
                            <th class="w-[10%]">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="tx-history-body">
                        <!-- Rows will be injected by JS -->
                    </tbody>
                </table>
            </div>
            <!-- We can add pagination controls here later if needed -->
        </div>
    </div>

    <!-- Notification placeholder -->
    <div id="notification"></div>

    <script>
    // --- Global State ---
    const TRANSACTION_HISTORY_KEY = 'transaction-history:v1';
    const ACCOUNT_STORAGE_KEY = 'account-dashboard:v1';
    
    let allTransactions = [];
    let allAccounts = [];
    let allLocations = [];
    let guestFilter = null; // To store the guest from URL

    // --- Utils ---
    function formatNumber(amount) {
        return new Intl.NumberFormat('en-US', {
            style: 'decimal', minimumFractionDigits: 2, maximumFractionDigits: 2
        }).format(amount);
    }
    
    function formatDateTime(isoString) {
        try {
            const date = new Date(isoString);
            return date.toLocaleString();
        } catch (e) {
            return isoString;
        }
    }

    function showNotification(message, type = 'error') {
        const notification = document.getElementById('notification');
        notification.textContent = message;
        notification.className = type === 'success' ? 'success' : 'error';
        notification.classList.add('show');
        setTimeout(() => { notification.classList.remove('show'); }, 3000);
    }

    // --- Data Functions ---
    function loadData() {
        try {
            // Load Transactions
            const rawTxs = localStorage.getItem(TRANSACTION_HISTORY_KEY);
            allTransactions = rawTxs ? JSON.parse(rawTxs) : [];

            // Load Account Data
            const rawAccounts = localStorage.getItem(ACCOUNT_STORAGE_KEY);
            const accountData = rawAccounts ? JSON.parse(rawAccounts) : { accounts: [], locations: [] };
            allAccounts = accountData.accounts || [];
            allLocations = accountData.locations || [];

            // Check for guest filter in URL
            const params = new URLSearchParams(window.location.search);
            guestFilter = params.get('guest');
            if (guestFilter) {
                document.getElementById('filter-account-no').value = guestFilter;
            }

        } catch (e) {
            console.error('Failed to load data:', e);
            showNotification('Error loading data from storage.');
        }
    }

    function saveAllTransactions() {
        try {
            localStorage.setItem(TRANSACTION_HISTORY_KEY, JSON.stringify(allTransactions));
            return true;
        } catch (e) {
            console.error('Failed to save transactions:', e);
            showNotification('Error saving transactions.');
            return false;
        }
    }

    function saveAccountData() {
        try {
            const raw = localStorage.getItem(ACCOUNT_STORAGE_KEY);
            const state = raw ? JSON.parse(raw) : {};
            const newState = { ...state, accounts: allAccounts, locations: allLocations };
            localStorage.setItem(ACCOUNT_STORAGE_KEY, JSON.stringify(newState));
            return true;
        } catch (e) {
            console.error('Failed to save account data:', e);
            showNotification('Error saving account data.');
            return false;
        }
    }
    
    // --- NEW: Universal saveTransaction function ---
    // (This is duplicated from account.html, in a real app this would be shared)
    function saveTransaction(txData) {
        try {
            const raw = localStorage.getItem(TRANSACTION_HISTORY_KEY);
            const allTxs = raw ? JSON.parse(raw) : [];
            
            const newTx = {
                id: `tx-${new Date().getTime()}`,
                timestamp: new Date().toISOString(),
                status: 'completed',
                ...txData
            };

            allTxs.push(newTx);
            allTransactions.push(newTx); // Add to our in-memory list
            localStorage.setItem(TRANSACTION_HISTORY_KEY, JSON.stringify(allTxs));
            return true;
        } catch (e) {
            console.error('Failed to save transaction:', e);
            showNotification('Error saving transaction log.');
            return false;
        }
    }

    // --- Table Rendering ---
    function renderTable() {
        const tbody = document.getElementById('tx-history-body');
        tbody.innerHTML = '';

        // Get filter values
        const accountFilter = document.getElementById('filter-account-no').value.trim().toLowerCase();
        const typeFilter = document.getElementById('filter-type').value;
        const dateStartFilter = document.getElementById('filter-date-start').value;
        const dateEndFilter = document.getElementById('filter-date-end').value;

        // 1. Filter the transactions
        const filteredTxs = allTransactions.filter(tx => {
            // Account No Filter (partial match)
            if (accountFilter && !tx.accountNo.toLowerCase().includes(accountFilter)) {
                return false;
            }
            
            // Type Filter
            if (typeFilter !== 'all' && tx.type !== typeFilter) {
                return false;
            }

            // Date Range Filter
            const txDate = tx.timestamp.slice(0, 10);
            if (dateStartFilter && txDate < dateStartFilter) {
                return false;
            }
            if (dateEndFilter && txDate > dateEndFilter) {
                return false;
            }
            
            return true;
        }).sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp)); // Sort by date, newest first

        // 2. Render the rows
        if (filteredTxs.length === 0) {
            tbody.innerHTML = `<tr><td colspan="8" class="text-center py-8 text-gray-400">No transactions found matching criteria.</td></tr>`;
        } else {
            filteredTxs.forEach(tx => {
                const tr = document.createElement('tr');
                
                const amountClass = tx.amount > 0 ? 'text-positive' : 'text-negative';
                const statusClass = tx.status === 'completed' ? 'status-completed' : 'status-voided';

                tr.innerHTML = `
                    <td>${formatDateTime(tx.timestamp)}</td>
                    <td>${tx.accountNo}</td>
                    <td>${tx.type}</td>
                    <td class="${amountClass}">${formatNumber(tx.amount)}</td>
                    <td>${tx.location || 'N/A'}</td>
                    <td><span class="status-badge ${statusClass}">${tx.status.toUpperCase()}</span></td>
                    <td>${tx.remarks || 'N/A'}</td>
                    <td>
                        ${tx.status === 'completed' ? 
                            `<button onclick="voidTransaction('${tx.id}')" class="bg-red-600 hover:bg-red-700 text-white p-2 rounded text-xs">Void</button>` : 
                            'N/A'
                        }
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }
    }

    // --- Actions ---

    function voidTransaction(txId) {
        const txIndex = allTransactions.findIndex(t => t.id === txId);
        if (txIndex === -1) {
            showNotification('Transaction not found.', 'error');
            return;
        }

        const tx = allTransactions[txIndex];
        
        if (tx.type.includes('Game')) {
            showNotification('Game transactions must be voided from the Game Record page.', 'error');
            return;
        }
        
        if (!confirm(`Are you sure you want to void this transaction?\n\n${tx.type} of ${formatNumber(tx.amount)} for ${tx.accountNo}\n\nThis will reverse the amount in the guest's account.`)) {
            return;
        }

        // --- 1. Find Guest Account ---
        const account = allAccounts.find(acc => acc.accountNumber === tx.accountNo);
        if (!account) {
            showNotification('Guest account not found. Cannot reverse transaction.', 'error');
            return;
        }

        // --- 2. Reverse the Transaction ---
        // We subtract the original amount (e.g., subtract a deposit, or subtract a negative withdrawal)
        const reverseAmount = -tx.amount;
        const loc = tx.location;
        if (!account.balances[loc]) account.balances[loc] = 0;
        
        account.balances[loc] += reverseAmount;
        
        // --- 3. Mark Original Transaction as Voided ---
        tx.status = 'voided';

        // --- 4. Create a new "Void" transaction ---
        saveTransaction({
            accountNo: tx.accountNo,
            type: 'Void',
            amount: reverseAmount,
            location: loc,
            remarks: `Void of transaction ${tx.id} (${tx.type})`
        });
        
        // --- 5. Save All Data ---
        if (saveAllTransactions() && saveAccountData()) {
            showNotification('Transaction voided successfully!', 'success');
            renderTable(); // Re-render the table
        } else {
            showNotification('Error saving voided transaction. Check console.', 'error');
            // Rollback (simple)
            tx.status = 'completed';
            account.balances[loc] -= reverseAmount;
        }
    }

    function exportTableToCSV() {
        const tbody = document.getElementById('tx-history-body');
        if (tbody.rows.length <= 1 && tbody.rows[0].cells.length <= 1) {
            showNotification('No data to export.', 'error');
            return;
        }

        const columns = [
            'Timestamp', 'Account No', 'Type', 'Amount', 'Location', 'Status', 'Remarks'
        ];
        
        let csvContent = "data:text/csv;charset=utf-8," + columns.join(",") + "\n";
        
        // Get filtered transactions again to export
        const accountFilter = document.getElementById('filter-account-no').value.trim().toLowerCase();
        const typeFilter = document.getElementById('filter-type').value;
        const dateStartFilter = document.getElementById('filter-date-start').value;
        const dateEndFilter = document.getElementById('filter-date-end').value;

        const filteredTxs = allTransactions.filter(tx => {
            if (accountFilter && !tx.accountNo.toLowerCase().includes(accountFilter)) return false;
            if (typeFilter !== 'all' && tx.type !== typeFilter) return false;
            const txDate = tx.timestamp.slice(0, 10);
            if (dateStartFilter && txDate < dateStartFilter) return false;
            if (dateEndFilter && txDate > dateEndFilter) return false;
            return true;
        }).sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));


        filteredTxs.forEach(tx => {
            const row = [
                `"${formatDateTime(tx.timestamp)}"`,
                tx.accountNo,
                tx.type,
                tx.amount,
                tx.location || 'N/A',
                tx.status,
                `"${(tx.remarks || '').replace(/"/g, '""')}"` 
            ];
            csvContent += row.join(",") + "\n";
        });

        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        
        const timestamp = new Date().toISOString().slice(0, 10);
        link.setAttribute("download", `transaction_history_${timestamp}.csv`);
        
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    // --- Initializer ---
    document.addEventListener('DOMContentLoaded', () => {
        loadData();
        renderTable();
        
        // Bind Filters
        document.getElementById('filter-apply-btn').addEventListener('click', renderTable);
        document.getElementById('filter-clear-btn').addEventListener('click', () => {
            document.getElementById('filter-account-no').value = guestFilter || ''; // Reset to URL guest or empty
            document.getElementById('filter-type').value = 'all';
            document.getElementById('filter-date-start').value = '';
            document.getElementById('filter-date-end').value = '';
            renderTable();
        });

        // Bind Export
        document.getElementById('export-csv-btn').addEventListener('click', exportTableToCSV);

        // Bind storage listener
        window.addEventListener('storage', (e) => {
            if (e.key === TRANSACTION_HISTORY_KEY || e.key === ACCOUNT_STORAGE_KEY) {
                loadData();
                renderTable();
            }
        });
    });
    </script>
</body>
</html>